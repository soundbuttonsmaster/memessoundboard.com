---
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import SoundButton from '../../components/SoundButton.astro';
import { searchSounds } from '../../lib/api';

export const prerender = false;

// Get search query from URL params (friendly URL: /search/query)
const { query: rawQuery } = Astro.params;
const query = rawQuery ? decodeURIComponent(rawQuery) : '';

// Fetch search results if query exists
let searchResults = [];
let totalCount = 0;
let nextPage = 2; // Start with page 2 for "Load More"
let hasQuery = false;

if (query && query.trim()) {
  hasQuery = true;
  try {
    const response = await searchSounds(query.trim(), 1, 55); // Fetch first page
    searchResults = response.results;
    totalCount = response.count;
    if (response.next) {
      nextPage = 2; // Set next page to 2 if there are more results
    } else {
      nextPage = 0; // No more pages
    }
  } catch (error) {
    console.error('Search error:', error);
    searchResults = [];
    totalCount = 0;
    nextPage = 0;
  }
}

// SEO Meta Data
const searchTerm = query.trim();
const pageTitle = searchTerm
  ? `${searchTerm} Sound Effect Buttons | Meme Soundboard`
  : 'Search Sound Buttons - MemesSoundBoard';
const pageDescription = searchTerm
  ? `Find meme buttons and soundboard unblocked results for ${searchTerm}. Play, explore, and download your favorite meme sounds.`
  : 'Search through thousands of sound buttons and meme sounds. Find the perfect sound effect for your needs.';
const pageKeywords = searchTerm
  ? `${searchTerm.toLowerCase()}, search sound buttons, meme sounds, sound effects, ${searchTerm.toLowerCase()} sounds`
  : 'search sound buttons, find sounds, sound effects search, meme soundboard search';
const canonicalUrl = `https://MemesSoundBoard/search${searchTerm ? `/${encodeURIComponent(searchTerm)}` : ''}`;
const ogImage = '/images/og-image.jpg';
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Primary Meta Tags -->
    <title>{pageTitle}</title>
    <meta name="title" content={pageTitle} />
    <meta name="description" content={pageDescription} />
    <meta name="keywords" content={pageKeywords} />
    <meta name="author" content="MemesSoundBoard" />
    <meta name="robots" content="index, follow" />
    <meta name="language" content="English" />
    <meta name="revisit-after" content="7 days" />

    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalUrl} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:site_name" content="MemesSoundBoard" />
    <meta property="og:locale" content="en_US" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={canonicalUrl} />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={pageDescription} />
    <meta name="twitter:image" content={ogImage} />

    <!-- Favicon Links -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />

    <link rel="stylesheet" href="/styles/global.css" />
  </head>
  <body>
    <Header />

    <main class="main-content">
      <!-- Breadcrumbs -->
      <nav class="breadcrumbs">
        <a href="/">Home</a> / <span>Search</span>
      </nav>

      <!-- Hero Section -->
      <div class="hero-section search-hero">
        <h1 class="main-title centered-title">
          {hasQuery 
            ? `${searchTerm} Sound Effect Buttons` 
            : 'Search Sound Buttons'}
        </h1>
        {hasQuery && (
          <p class="main-description centered-description">
            Found {totalCount} sound{totalCount !== 1 ? 's' : ''} matching "{searchTerm}"
          </p>
        )}
      </div>

      <!-- Search Results Section -->
      {hasQuery && searchResults.length > 0 && (
        <section class="sounds-section search-results-section">
          <div class="section-header">
            <div class="section-title-wrapper">
              <h2 class="section-title">Search Results : {searchTerm}</h2>
            </div>
          </div>
          <div class="sounds-grid" id="searchResultsGrid">
            {searchResults.map((sound) => (
              <SoundButton sound={sound} />
            ))}
          </div>
        </section>
      )}

      <!-- No Results -->
      {hasQuery && searchResults.length === 0 && (
        <section class="sounds-section">
          <div class="section-header">
            <div class="section-title-wrapper">
              <h2 class="section-title">Sound Buttons : Search Results</h2>
            </div>
          </div>
          <hr class="section-divider" />
          <div class="no-results-container">
            <div class="no-results-icon">
              <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
                <line x1="8" y1="11" x2="14" y2="11"></line>
              </svg>
            </div>
            <h3 class="no-results-title">No Results Found</h3>
            <p class="no-results-text">
              We couldn't find any sounds matching "<strong>{searchTerm}</strong>". Try different keywords or browse all sounds.
            </p>
            <div class="no-results-actions">
              <a href="/" class="btn-primary">Browse All Sounds</a>
              <button onclick="history.back()" class="btn-secondary">Go Back</button>
            </div>
          </div>
        </section>
      )}

      <!-- No Search Query -->
      {!hasQuery && (
        <section class="sounds-section">
          <div class="section-header">
            <div class="section-title-wrapper">
              <h2 class="section-title">Start Your Search</h2>
            </div>
          </div>
          <hr class="section-divider" />
          <div class="no-search-container">
            <div class="search-prompt-icon">
              <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
            </div>
            <h3 class="no-search-title">Search for Sound Buttons</h3>
            <p class="no-search-text">
              Use the search bar above to find your favorite sound buttons, meme sounds, and sound effects.
            </p>
            <div class="popular-searches">
              <h4>Popular Searches:</h4>
              <div class="popular-tags">
                <a href="/search/meme" class="tag-link">meme</a>
                <a href="/search/funny" class="tag-link">funny</a>
                <a href="/search/sound%20effects" class="tag-link">sound effects</a>
                <a href="/search/gaming" class="tag-link">gaming</a>
                <a href="/search/prank" class="tag-link">prank</a>
                <a href="/search/reaction" class="tag-link">reaction</a>
              </div>
            </div>
            <div class="browse-action">
              <a href="/" class="explore-more-button">
                Browse All Sounds
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="5 3 19 12 5 21 5 3"/>
                </svg>
              </a>
            </div>
          </div>
        </section>
      )}

      <script type="module" define:vars={{ query, nextPage, totalCount }}>
        const loadMoreButton = document.getElementById('loadMoreSounds');
        const searchResultsGrid = document.getElementById('searchResultsGrid');
        let currentPage = nextPage;
        let currentTotalCount = totalCount;

        if (loadMoreButton) {
          loadMoreButton.addEventListener('click', async () => {
            if (currentPage === 0) return; // No more pages

            loadMoreButton.textContent = 'Loading...';
            loadMoreButton.disabled = true;

            try {
              const response = await fetch(`/api/search-sounds?name=${encodeURIComponent(query)}&page=${currentPage}&page_size=55`);
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              const data = await response.json();
              const newSounds = data.results;
              currentTotalCount = data.count;

              // Helper to create slug (duplicated from SoundButton to ensure consistency)
              function slugify(text) {
                  return text.toLowerCase().trim().replace(/[^\w\s-]/g, '').replace(/[\s_-]+/g, '-').replace(/^-+|-+$/g, '');
              }

              // Generate HTML for new sounds (matching SoundButton.astro structure)
              const newHtml = newSounds.map(sound => {
                const buttonColor = ['#FF5733', '#33FF57', '#3357FF', '#FF33A1', '#A133FF', '#33FFF5', '#F5FF33'][sound.id % 7];
                const isFavorited = sound.is_favorited;

                return `
                  <div class="instant">
                    <div
                      class="sprite-wrapper"
                      data-audio-url="/api/sounds/${sound.id}/audio"
                      data-sound-id="${sound.id}"
                    >
                      <div
                        class="inner-btn"
                        style="background: ${buttonColor};"
                      ></div>
                      <div class="button-ring"></div>
                    </div>

                    <a href="/instant/${slugify(sound.name)}-${sound.id}" class="instant-link link-secondary" onclick="event.stopPropagation()" onmousedown="event.stopPropagation()" ontouchstart="event.stopPropagation()">${sound.name}</a>

                    <div class="result-page-instant-sharebox">
                      <button type="button" class="instant-action-button favorite-btn" data-sound-id="${sound.id}" title="Add ${sound.name} to favorites">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="${isFavorited ? "currentColor" : "none"}" stroke="currentColor" stroke-width="2" style="font-size: 1.3rem; color: red;">
                          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                        </svg>
                      </button>
                      <button type="button" class="instant-action-button webshare" data-sound-id="${sound.id}" title="Share ${sound.name}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="font-size: 1.3rem; color: cornflowerblue;">
                          <circle cx="18" cy="5" r="3"/>
                          <circle cx="6" cy="12" r="3"/>
                          <circle cx="18" cy="19" r="3"/>
                          <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                          <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                        </svg>
                      </button>
                      <a href="/api/sounds/${sound.id}/audio?download=true" download="${sound.name}" class="instant-action-button download-btn" title="Download ${sound.name}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="font-size: 1.3rem; color: #2ECC71;">
                          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                          <polyline points="7 10 12 15 17 10"/>
                          <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                      </a>
                    </div>
                  </div>
                `;
              }).join('');

              // Append new sounds
              searchResultsGrid.insertAdjacentHTML('beforeend', newHtml);

              // Re-initialize buttons
              if (window.SoundBoard) {
                window.SoundBoard.initAllSoundButtons();
                window.SoundBoard.initActionButtons();
              }

              if (data.next) {
                currentPage++;
              } else {
                currentPage = 0; // No more pages
                loadMoreButton.remove();
              }
            } catch (error) {
              console.error('Error loading more sounds:', error);
              loadMoreButton.textContent = 'Error - Try Again';
              loadMoreButton.disabled = false;
            } finally {
              if (currentPage > 0) {
                loadMoreButton.textContent = 'Load More';
                loadMoreButton.disabled = false;
              }
            }
          });
        }
      </script>
    </main>

    <Footer />

    <style>
      /* Breadcrumbs */
      .breadcrumbs {
        margin-bottom: 2rem;
        font-size: 0.9rem;
        color: var(--text-secondary);
      }

      .breadcrumbs a {
        color: var(--primary-color);
        text-decoration: none;
      }

      .breadcrumbs a:hover {
        text-decoration: underline;
      }

      /* Hero Section */
      .search-hero {
        margin-bottom: 3rem;
        text-align: center;
      }

      .centered-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: var(--text-primary);
      }

      .centered-description {
        font-size: 1.1rem;
        color: var(--text-secondary);
        opacity: 0.8;
      }

      /* Search Results Table/Grid */
      .search-results-section {
        margin-top: 2rem;
      }

      .search-results-section .section-title {
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
        text-align: left;
      }

      /* Load More Button */
      .load-more-container {
        display: flex;
        justify-content: center;
        margin-top: 2rem;
      }

      .load-more-button {
        background-color: var(--primary-color);
        color: var(--white);
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .load-more-button:hover:not(:disabled) {
        background-color: #2980b9;
        transform: translateY(-1px);
      }

      .load-more-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      /* No Results */
      .no-results-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 4rem 2rem;
        text-align: center;
      }

      .no-results-icon {
        color: var(--text-light);
        margin-bottom: 1.5rem;
        opacity: 0.5;
      }

      .no-results-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.75rem;
      }

      .no-results-text {
        font-size: 1rem;
        color: var(--text-secondary);
        max-width: 500px;
        margin-bottom: 2rem;
        line-height: 1.6;
      }

      .no-results-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        justify-content: center;
      }

      .btn-primary,
      .btn-secondary {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.95rem;
        text-decoration: none;
        transition: all 0.2s ease;
        cursor: pointer;
        border: none;
      }

      .btn-primary {
        background-color: var(--primary-color);
        color: var(--white);
      }

      .btn-primary:hover {
        background-color: #2980b9;
        transform: translateY(-1px);
      }

      .btn-secondary {
        background-color: var(--bg-light);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }

      .btn-secondary:hover {
        background-color: rgba(52, 152, 219, 0.05);
        border-color: var(--primary-color);
      }

      /* No Search Query */
      .no-search-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 4rem 2rem;
        text-align: center;
      }

      .search-prompt-icon {
        color: var(--text-light);
        margin-bottom: 1.5rem;
        opacity: 0.5;
      }

      .no-search-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.75rem;
      }

      .no-search-text {
        font-size: 1rem;
        color: var(--text-secondary);
        max-width: 500px;
        margin-bottom: 2rem;
        line-height: 1.6;
      }

      .popular-searches {
        background-color: var(--bg-light);
        padding: 1.5rem 2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        max-width: 600px;
        width: 100%;
      }

      .popular-searches h4 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 1rem;
        text-align: left;
      }

      .popular-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        justify-content: flex-start;
      }

      .tag-link {
        display: inline-block;
        padding: 0.5rem 1rem;
        background-color: var(--white);
        color: var(--primary-color);
        text-decoration: none;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
        border: 1px solid var(--primary-color);
        transition: all 0.2s ease;
      }

      .tag-link:hover {
        background-color: var(--primary-color);
        color: var(--white);
        transform: translateY(-1px);
      }

      .browse-action {
        margin-top: 1rem;
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .breadcrumbs {
          margin-bottom: 1rem;
        }

        .centered-title {
          font-size: 1.75rem;
        }

        .centered-description {
          font-size: 0.95rem;
        }

        .no-results-container,
        .no-search-container {
          padding: 2rem 1rem;
        }

        .no-results-title,
        .no-search-title {
          font-size: 1.25rem;
        }

        .no-results-text,
        .no-search-text {
          font-size: 0.95rem;
        }

        .popular-searches {
          padding: 1rem 1.25rem;
        }

        .popular-tags {
          gap: 0.5rem;
        }

        .tag-link {
          font-size: 0.85rem;
          padding: 0.4rem 0.85rem;
        }
      }
    </style>
  </body>
</html>
