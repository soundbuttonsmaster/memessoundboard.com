---
import { fetchCategories } from '../lib/api';

// Fetch categories server-side
const categories = await fetchCategories();

// Helper function to create URL-friendly slugs
function slugify(text: string): string {
  return text
    .toLowerCase()
    .trim()
    .replace(/[^\w\s-]/g, '') // Remove special characters
    .replace(/[\s_-]+/g, '-') // Replace spaces and underscores with hyphens
    .replace(/^-+|-+$/g, ''); // Remove leading/trailing hyphens
}
---

<header class="header">
  <div class="header-container">
    <!-- Logo -->
    <div class="logo">
      <a href="/">Memes Soundboard</a>
    </div>

    <!-- Desktop Navigation -->
    <nav class="nav desktop-nav">
      <a href="/" class="nav-link">HOME</a>
      <a href="/new" class="nav-link">NEW</a>
      <a href="/trending" class="nav-link">TRENDS</a>
      <div class="nav-link dropdown" id="categoriesDropdown">
        CATEGORIES
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 9l6 6 6-6"/>
        </svg>
        {categories.length > 0 && (
          <div class="dropdown-menu" id="categoriesMenu">
            {categories.map((category) => (
              <div class="dropdown-item-wrapper">
                <a href={`/${slugify(category.name)}/${category.id}`} class="dropdown-item">
                  {category.name}
                  {category.children && category.children.length > 0 && (
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="dropdown-arrow">
                      <path d="M9 18l6-6-6-6"/>
                    </svg>
                  )}
                </a>
                {category.children && category.children.length > 0 && (
                  <div class="dropdown-submenu">
                    {category.children.map((child) => (
                      <a href={`/${slugify(child.name)}/${child.id}`} class="dropdown-item submenu-item">
                        {child.name}
                      </a>
                    ))}
                  </div>
                )}
              </div>
            ))}
          </div>
        )}
      </div>
      <a href="/play-random" class="nav-link">PLAY RANDOM</a>
    </nav>

    <!-- Desktop Search Bar -->
    <div class="header-search desktop-search">
      <form class="search-wrapper" id="headerSearchForm" action="/search" method="GET">
        <input 
          type="text" 
          name="q"
          class="search-input" 
          placeholder="Search sounds..." 
          id="headerSearchInput"
          autocomplete="off"
        />
        <button type="submit" class="search-button" aria-label="Search">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </button>
      </form>
    </div>

    <!-- Desktop User Actions -->
    <div class="user-actions desktop-actions">
      <!-- Guest Actions -->
      <div class="guest-actions" id="guestActions">
        <a href="/login" class="btn btn-login">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
          </svg>
          Login
        </a>
        <a href="/signup" class="btn btn-signup">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14M5 12h14"/>
          </svg>
          Sign Up
        </a>
      </div>

      <!-- Authenticated Actions -->
      <div class="authenticated-actions" id="authenticatedActions" style="display: none;">
        <div class="user-profile-dropdown" id="userProfileDropdown">
          <button class="user-icon-btn" id="userIconBtn" aria-label="User menu">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
          </button>
          <div class="user-dropdown-menu" id="userDropdownMenu">
            <a href="/profile" class="user-dropdown-item">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
              My Profile
            </a>
            <a href="/favorites" class="user-dropdown-item">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px; color: red;">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
              </svg>
              User Fav
            </a>
            <button class="user-dropdown-item logout-item" id="logoutBtn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                <polyline points="16,17 21,12 16,7"/>
                <line x1="21" y1="12" x2="9" y2="12"/>
              </svg>
              Logout
            </button>
          </div>
        </div>
      </div>

      <!-- Upload Button (always visible) -->
      <a href="/upload" class="btn btn-upload">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
        </svg>
        Upload
      </a>
    </div>

    <!-- Mobile Icons -->
    <div class="mobile-header-actions">
      <button class="mobile-search-btn" id="mobileSearchBtn" aria-label="Search">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
      </button>
      <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Menu">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="menu-icon">
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="close-icon" style="display: none;">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>

  <!-- Mobile Full Screen Menu -->
  <div class="mobile-menu-overlay" id="mobileMenuOverlay">
    <div class="mobile-menu-content">
      <!-- Mobile Search -->
      <div class="mobile-search-section">
        <form class="mobile-search-wrapper" id="mobileSearchForm" action="/search" method="GET">
          <input 
            type="text" 
            name="q"
            class="mobile-search-input" 
            placeholder="Search sounds..." 
            id="mobileSearchInput"
            autocomplete="off"
          />
          <button type="submit" class="mobile-search-submit" aria-label="Search">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
          </button>
        </form>
      </div>

      <!-- Mobile Navigation -->
      <nav class="mobile-nav">
        <a href="/new" class="mobile-nav-link">NEW</a>
        <a href="/trending" class="mobile-nav-link">TRENDS</a>
        <div class="mobile-nav-link mobile-categories-toggle" id="mobileCategoriesToggle">
          CATEGORIES
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="categories-arrow">
            <path d="M6 9l6 6 6-6"/>
          </svg>
        </div>
        <div class="mobile-categories-menu" id="mobileCategoriesMenu">
          {categories.length > 0 && categories.map((category) => (
            <a href={`/${slugify(category.name)}/${category.id}`} class="mobile-nav-link mobile-category-link">
              {category.name}
            </a>
          ))}
        </div>
        <a href="/play-random" class="mobile-nav-link">PLAY RANDOM</a>
        <a href="/upload" class="mobile-nav-link">UPLOAD</a>
      </nav>

      <!-- Mobile User Actions -->
      <div class="mobile-user-actions">
        <!-- Mobile Guest Actions -->
        <div class="mobile-guest-actions" id="mobileGuestActions">
          <a href="/login" class="mobile-btn mobile-btn-login">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </svg>
            Login
          </a>
          <a href="/signup" class="mobile-btn mobile-btn-signup">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 5v14M5 12h14"/>
            </svg>
            Sign Up
          </a>
        </div>

        <!-- Mobile Authenticated Actions -->
        <div class="mobile-authenticated-actions" id="mobileAuthenticatedActions" style="display: none;">
          <div class="mobile-user-profile-dropdown" id="mobileUserProfileDropdown">
            <a href="/profile" class="mobile-btn mobile-btn-profile">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
              My Profile
            </a>
            <a href="/favorites" class="mobile-btn mobile-btn-profile">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: red;">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
              </svg>
              User Fav
            </a>
            <button class="mobile-btn mobile-btn-logout" id="mobileLogoutBtn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                <polyline points="16,17 21,12 16,7"/>
                <line x1="21" y1="12" x2="9" y2="12"/>
              </svg>
              Logout
            </button>
          </div>
        </div>

        <!-- Mobile Upload Button (always visible) -->
        <a href="/upload" class="mobile-btn mobile-btn-upload">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
          </svg>
          Upload
        </a>
      </div>
    </div>
  </div>

  </header>

<script is:inline>
  // Header search functionality - runs immediately
  (function() {
    function initSearch() {
      const headerSearchForm = document.getElementById('headerSearchForm');
      const headerSearchInput = document.getElementById('headerSearchInput');
      const headerSearchButton = document.querySelector('.header-search .search-button');
    
      function handleHeaderSearch(e) {
        if (e) {
          e.preventDefault();
        }
        const query = headerSearchInput?.value.trim();
        if (query) {
          window.location.href = `/search/${encodeURIComponent(query)}`;
        }
      }
    
      // Handle form submission (Enter key)
      if (headerSearchForm) {
        headerSearchForm.addEventListener('submit', handleHeaderSearch);
      }
      
      // Handle button click
      if (headerSearchButton) {
        headerSearchButton.addEventListener('click', handleHeaderSearch);
      }

      // Mobile search functionality
      const mobileSearchForm = document.getElementById('mobileSearchForm');
      const mobileSearchInput = document.getElementById('mobileSearchInput');
      const mobileSearchSubmit = document.querySelector('.mobile-search-submit');
      
      function handleMobileSearch(e) {
        if (e) {
          e.preventDefault();
        }
        const query = mobileSearchInput?.value.trim();
        if (query) {
          window.location.href = `/search/${encodeURIComponent(query)}`;
        }
      }
      
      // Handle form submission (Enter key)
      if (mobileSearchForm) {
        mobileSearchForm.addEventListener('submit', handleMobileSearch);
      }
      
      // Handle button click
      if (mobileSearchSubmit) {
        mobileSearchSubmit.addEventListener('click', handleMobileSearch);
      }
    }

    function updateAuthUI() {
      const isAuth = !!localStorage.getItem('auth_token');
      const guestActions = document.getElementById('guestActions');
      const authenticatedActions = document.getElementById('authenticatedActions');
      const mobileGuestActions = document.getElementById('mobileGuestActions');
      const mobileAuthenticatedActions = document.getElementById('mobileAuthenticatedActions');

      if (isAuth) {
        if (guestActions) guestActions.style.display = 'none';
        if (authenticatedActions) authenticatedActions.style.display = 'flex';
        if (mobileGuestActions) mobileGuestActions.style.display = 'none';
        if (mobileAuthenticatedActions) mobileAuthenticatedActions.style.display = 'flex';
      } else {
        if (guestActions) guestActions.style.display = 'flex';
        if (authenticatedActions) authenticatedActions.style.display = 'none';
        if (mobileGuestActions) mobileGuestActions.style.display = 'flex';
        if (mobileAuthenticatedActions) mobileAuthenticatedActions.style.display = 'none';
      }
    }

    // Initialize immediately if DOM is ready, otherwise wait
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        initSearch();
        updateAuthUI();
      });
    } else {
      initSearch();
      updateAuthUI();
    }
  })();

  function logout() {
    localStorage.removeItem('auth_token');
    localStorage.removeItem('user_data');
    window.location.href = '/';
  }

  // Mobile menu toggle
  const mobileMenuBtn = document.getElementById('mobileMenuBtn');
  const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
  const menuIcon = mobileMenuBtn?.querySelector('.menu-icon');
  const closeIcon = mobileMenuBtn?.querySelector('.close-icon');
  
  function toggleMobileMenu() {
    if (mobileMenuOverlay) {
      const isOpen = mobileMenuOverlay.classList.contains('active');
      if (isOpen) {
        mobileMenuOverlay.classList.remove('active');
        document.body.style.overflow = '';
        if (menuIcon) menuIcon.style.display = 'block';
        if (closeIcon) closeIcon.style.display = 'none';
      } else {
        mobileMenuOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
        if (menuIcon) menuIcon.style.display = 'none';
        if (closeIcon) closeIcon.style.display = 'block';
      }
    }
  }
  
  mobileMenuBtn?.addEventListener('click', toggleMobileMenu);
  
  // Close menu when clicking overlay
  mobileMenuOverlay?.addEventListener('click', (e) => {
    if (e.target === mobileMenuOverlay) {
      toggleMobileMenu();
    }
  });

  // Mobile categories toggle
  const mobileCategoriesToggle = document.getElementById('mobileCategoriesToggle');
  const mobileCategoriesMenu = document.getElementById('mobileCategoriesMenu');
  const categoriesArrow = mobileCategoriesToggle?.querySelector('.categories-arrow');
  
  mobileCategoriesToggle?.addEventListener('click', () => {
    if (mobileCategoriesMenu) {
      mobileCategoriesMenu.classList.toggle('active');
      if (categoriesArrow) {
        categoriesArrow.style.transform = mobileCategoriesMenu.classList.contains('active') 
          ? 'rotate(180deg)' 
          : 'rotate(0deg)';
      }
    }
  });

  // Categories dropdown functionality (desktop)
  const categoriesDropdown = document.getElementById('categoriesDropdown');
  const categoriesMenu = document.getElementById('categoriesMenu');
  
  if (categoriesDropdown && categoriesMenu) {
    let dropdownTimeout = null;
    
    const updateDropdownPosition = () => {
      if (categoriesMenu.style.display === 'block' || categoriesMenu.style.display === '') {
        const rect = categoriesDropdown.getBoundingClientRect();
        categoriesMenu.style.top = `${rect.bottom + window.scrollY + 8}px`;
        categoriesMenu.style.left = `${rect.left + window.scrollX}px`;
      }
    };
    
    const showDropdown = () => {
      if (dropdownTimeout) {
        clearTimeout(dropdownTimeout);
        dropdownTimeout = null;
      }
      categoriesDropdown.classList.add('active');
      categoriesMenu.style.display = 'block';
      updateDropdownPosition();
    };
    
    const hideDropdown = () => {
      dropdownTimeout = window.setTimeout(() => {
        categoriesDropdown.classList.remove('active');
        categoriesMenu.style.display = 'none';
      }, 150);
    };
    
    categoriesDropdown.addEventListener('mouseenter', showDropdown);
    categoriesDropdown.addEventListener('mouseleave', hideDropdown);
    
    categoriesMenu.addEventListener('mouseenter', showDropdown);
    categoriesMenu.addEventListener('mouseleave', hideDropdown);

    // Handle click - don't prevent default, allow links to work
    categoriesDropdown.addEventListener('click', (e) => {
      // Only toggle if clicking the button itself, not a link inside
      if (e.target === categoriesDropdown || categoriesDropdown.contains(e.target)) {
        const isLink = e.target.closest('a');
        if (!isLink) {
          e.stopPropagation();
          const isActive = categoriesDropdown.classList.contains('active');
          if (isActive) {
            categoriesDropdown.classList.remove('active');
            categoriesMenu.style.display = 'none';
          } else {
            categoriesDropdown.classList.add('active');
            categoriesMenu.style.display = 'block';
            updateDropdownPosition();
          }
        }
      }
    });

    // Allow category links to navigate immediately - don't block them
    const categoryLinks = categoriesMenu.querySelectorAll('a.dropdown-item');
    categoryLinks.forEach((link) => {
      link.addEventListener('click', (e) => {
        // Clear any pending hide timeout when clicking a link
        if (dropdownTimeout) {
          clearTimeout(dropdownTimeout);
          dropdownTimeout = null;
        }
        // Allow navigation to proceed immediately
        categoriesDropdown.classList.remove('active');
        categoriesMenu.style.display = 'none';
      });
    });

    // Update position on scroll and resize
    window.addEventListener('scroll', updateDropdownPosition, true);
    window.addEventListener('resize', updateDropdownPosition);

    // Update submenu positions
    const updateSubmenuPositions = () => {
      document.querySelectorAll('.dropdown-item-wrapper').forEach((wrapper) => {
        const submenu = wrapper.querySelector('.dropdown-submenu');
        if (submenu && wrapper.matches(':hover')) {
          const wrapperRect = wrapper.getBoundingClientRect();
          submenu.style.top = `${wrapperRect.top + window.scrollY}px`;
          submenu.style.left = `${wrapperRect.right + window.scrollX + 8}px`;
        }
      });
    };

    categoriesMenu.addEventListener('mouseover', updateSubmenuPositions);

    document.addEventListener('click', (e) => {
      const target = e.target;
      if (!categoriesDropdown.contains(target) && !categoriesMenu.contains(target)) {
        if (dropdownTimeout) {
          clearTimeout(dropdownTimeout);
          dropdownTimeout = null;
        }
        categoriesDropdown.classList.remove('active');
        categoriesMenu.style.display = 'none';
      }
    });
  }

// Authentication state management

/*
function updateAuthUI() {
  const isAuth = isAuthenticated();
  const guestActions = document.getElementById('guestActions');
  const authenticatedActions = document.getElementById('authenticatedActions');
  const mobileGuestActions = document.getElementById('mobileGuestActions');
  const mobileAuthenticatedActions = document.getElementById('mobileAuthenticatedActions');

  if (isAuth) {
    // Show authenticated actions, hide guest actions
    if (guestActions) guestActions.style.display = 'none';
    if (authenticatedActions) authenticatedActions.style.display = 'flex';
    if (mobileGuestActions) mobileGuestActions.style.display = 'none';
    if (mobileAuthenticatedActions) mobileAuthenticatedActions.style.display = 'flex';
  } else {
    // Show guest actions, hide authenticated actions
    if (guestActions) guestActions.style.display = 'flex';
    if (authenticatedActions) authenticatedActions.style.display = 'none';
    if (mobileGuestActions) mobileGuestActions.style.display = 'flex';
    if (mobileAuthenticatedActions) mobileAuthenticatedActions.style.display = 'none';
  }
}
*/

// User dropdown functionality
const userIconBtn = document.getElementById('userIconBtn');
const userProfileDropdown = document.getElementById('userProfileDropdown');
const userDropdownMenu = document.getElementById('userDropdownMenu');

if (userIconBtn && userProfileDropdown && userDropdownMenu) {
  const updateUserDropdownPosition = () => {
    const rect = userIconBtn.getBoundingClientRect();
    userDropdownMenu.style.top = `${rect.bottom + window.scrollY + 8}px`;
    userDropdownMenu.style.right = `${window.innerWidth - rect.right - window.scrollX}px`;
  };

  userIconBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    const isActive = userProfileDropdown.classList.contains('active');
    if (isActive) {
      userProfileDropdown.classList.remove('active');
    } else {
      userProfileDropdown.classList.add('active');
      updateUserDropdownPosition();
    }
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    const target = e.target;
    if (!userProfileDropdown.contains(target)) {
      userProfileDropdown.classList.remove('active');
    }
  });

  // Update position on scroll and resize
  window.addEventListener('scroll', () => {
    if (userProfileDropdown.classList.contains('active')) {
      updateUserDropdownPosition();
    }
  });
  window.addEventListener('resize', () => {
    if (userProfileDropdown.classList.contains('active')) {
      updateUserDropdownPosition();
    }
  });
}

// Logout functionality
const logoutBtn = document.getElementById('logoutBtn');
const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');

function handleLogout() {
  logout();
}

if (logoutBtn) {
  logoutBtn.addEventListener('click', handleLogout);
}

if (mobileLogoutBtn) {
  mobileLogoutBtn.addEventListener('click', handleLogout);
}

  // Initialize auth UI on page load
  // document.addEventListener('DOMContentLoaded', updateAuthUI);
</script>

